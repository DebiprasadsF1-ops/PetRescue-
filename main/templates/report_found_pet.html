{% extends 'base.html' %}
{% load static %}

{% block title %}Report Found Pet | PetRescue{% endblock %}

{% block head_extra %}
<!-- Google Fonts + Animate.css -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<style>
  /* ===== THEME (Aqua Green & Sky Blue) ===== */
  :root{
    --bg-1:#e6faff;          /* sky tint */
    --bg-2:#e8fff4;          /* aqua tint */
    --aqua:#10b981;          /* emerald/aqua */
    --aqua-700:#0e9f6e;
    --aqua-900:#0b7a56;
    --sky:#22c7ff;           /* bright sky */
    --sky-700:#1590c9;
    --ink:#0f172a;           /* dark text */
    --muted:#6b7280;         /* muted text */
    --white:#ffffff;
    --glass:rgba(255,255,255,0.18);
    --ring:rgba(16,185,129,.35);
    --ring-sky:rgba(34,199,255,.35);
    --shadow:0 12px 40px rgba(15,23,42,.15);
    --radius:20px;
  }

  /* ===== PAGE BACKDROP ===== */
  body{ overflow-x:hidden; }
  .found-pet-bg{
    min-height:100vh;
    padding:clamp(16px,2.5vw,32px) 0;
    font-family:'Poppins',sans-serif;
    background:
      radial-gradient(1200px 600px at 5% -10%, rgba(34,199,255,.25), transparent 60%),
      radial-gradient(900px 500px at 100% 10%, rgba(16,185,129,.22), transparent 65%),
      linear-gradient(135deg, var(--bg-1) 0%, var(--bg-2) 100%);
    position:relative;
    isolation:isolate;
  }

  /* Floating paws (soft, subtle) */
  .paws{
    position:absolute; inset:0; pointer-events:none; z-index:-1; opacity:.25;
    background-image:
      url("data:image/svg+xml;utf8,<svg width='160' height='160' viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><g fill='%2310b981'><circle cx='14' cy='14' r='5'/><circle cx='28' cy='10' r='4'/><circle cx='10' cy='28' r='4'/><circle cx='26' cy='26' r='5'/><path d='M40 42c6 0 10 3 10 8 0 3-3 6-10 6s-10-3-10-6c0-5 4-8 10-8z'/></g></svg>");
    background-size:160px 160px;
    animation: drift 30s linear infinite;
  }
  @keyframes drift { from{transform:translateY(0)} to{transform:translateY(-60px)} }

  /* ===== HEADER ===== */
  .header-wrap{
    text-align:center; margin-bottom:24px;
  }
  .hero-chip{
    display:inline-flex; align-items:center; gap:.5rem;
    background:linear-gradient(90deg, rgba(34,199,255,.2), rgba(16,185,129,.2));
    border:1px solid rgba(16,185,129,.25);
    color:var(--aqua-900);
    padding:.5rem .9rem; border-radius:999px; font-weight:600; font-size:.9rem;
    backdrop-filter: blur(6px);
  }
  .page-title{
    font-weight:800; line-height:1.1;
    font-size: clamp(1.8rem, 3vw, 2.6rem);
    margin:14px 0 8px; color:var(--ink);
    text-shadow:0 1px 0 rgba(255,255,255,.75);
  }
  .page-sub{
    color:var(--muted);
    max-width:780px; margin:0 auto;
  }

  /* ===== CARD (Glass) ===== */
  .report-card{
    border:none; border-radius:var(--radius); overflow:hidden;
    background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.82));
    box-shadow:var(--shadow); backdrop-filter: blur(10px);
    transform: translateY(0);
    transition: transform .35s ease, box-shadow .35s ease;
  }
  .report-card:hover{ transform: translateY(-4px); box-shadow: 0 16px 48px rgba(15,23,42,.18); }

  .card-header-found{
    border-bottom:none; text-align:center; padding:28px 18px;
    background:
      radial-gradient(60% 120% at 0% 0%, rgba(34,199,255,.35), transparent 60%),
      radial-gradient(60% 120% at 100% 0%, rgba(16,185,129,.35), transparent 60%),
      linear-gradient(90deg, var(--sky) 0%, var(--aqua) 100%);
    color:var(--white);
  }
  .card-header-found h2{ margin:0; font-weight:700; letter-spacing:.3px; }
  .card-header-found p{ margin:.35rem 0 0; opacity:.9; }

  .form-container{ padding:clamp(18px,2.2vw,28px); }

  /* ===== FORM CONTROLS ===== */
  .form-label{ font-weight:600; color:var(--ink); margin-bottom:.35rem; }
  .form-control, .form-select, textarea{
    border:2px solid #e8eef4; border-radius:14px;
    background:#f2fbff; padding:.8rem 1rem; color:#0b2b34;
    transition:border-color .25s ease, box-shadow .25s ease, background .25s ease, transform .15s ease;
  }
  .form-control:focus, .form-select:focus, textarea:focus{
    background:#ffffff;
    border-color: var(--sky);
    box-shadow: 0 0 0 .25rem var(--ring-sky);
    outline: none; transform: translateY(-1px);
  }
  .form-text{ color:#64748b; }

  /* ===== IMAGE UPLOAD ===== */
  .image-upload-area{
    border:2px dashed var(--aqua); border-radius:14px;
    padding:1.4rem; text-align:center; background:rgba(16,185,129,.06);
    transition: all .25s ease; cursor:pointer;
  }
  .image-upload-area:hover{
    background:rgba(34,199,255,.08); border-color:var(--sky);
    box-shadow: 0 0 0 .2rem rgba(34,199,255,.15);
  }
  .image-upload-area i{ font-size:2rem; color:var(--aqua); margin-bottom:.5rem; }

  .image-preview-container{ display:none; }
  .preview-image{
    width:100%; height:140px; object-fit:cover; border-radius:12px;
    border:2px solid #fff; box-shadow:0 6px 16px rgba(2,6,23,.15);
    transition: transform .35s ease;
  }
  .preview-col{ position:relative; }
  .preview-col:hover .preview-image{ transform: scale(1.03); }
  .remove-btn, .add-more-btn{
    position:absolute; display:flex; align-items:center; justify-content:center;
    width:34px; height:34px; border-radius:50%; cursor:pointer; transition:all .2s ease;
    background:rgba(255,255,255,.95); box-shadow:0 4px 10px rgba(2,6,23,.18);
  }
  .remove-btn{ top:8px; right:8px; border:2px solid #ef4444; }
  .remove-btn i{ color:#ef4444; }
  .remove-btn:hover{ background:#ef4444; transform:scale(1.06); }
  .remove-btn:hover i{ color:#fff; }
  .add-more-btn{ right:10px; bottom:10px; border:2px solid var(--aqua);}
  .add-more-btn i{ color:var(--aqua); }
  .add-more-btn:hover{ background:var(--aqua); transform:scale(1.06); }
  .add-more-btn:hover i{ color:#fff; }

  /* ===== BUTTONS ===== */
  .btn-found-pet{
    background:linear-gradient(90deg, var(--aqua) 0%, var(--sky) 100%);
    border:none; color:#fff; font-weight:700; font-size:1.05rem;
    border-radius:999px; padding:.85rem 1.6rem; box-shadow:0 10px 24px rgba(16,185,129,.35);
    transition: transform .2s ease, box-shadow .25s ease, filter .2s ease;
  }
  .btn-found-pet:hover{ transform: translateY(-2px); filter:brightness(1.02); box-shadow:0 14px 34px rgba(34,199,255,.35); }
  .btn-found-pet:active{ transform: translateY(0); }

  .btn-cancel{
    border:none; color:#0b2740; background:#e6f4ff;
    border-radius:999px; padding:.85rem 1.25rem; font-weight:700;
    transition:transform .2s ease, box-shadow .2s ease;
  }
  .btn-cancel:hover{ transform: translateY(-2px); box-shadow:0 10px 20px rgba(15,23,42,.12); }

  /* ===== ALERT ===== */
  .alert-found{
    border:none; border-radius:16px; padding:1.1rem 1rem;
    background:linear-gradient(135deg, rgba(240,253,244,1) 0%, rgba(236,253,245,1) 100%);
    border-left:6px solid var(--aqua);
    box-shadow:var(--shadow);
  }
  .alert-found .alert-heading{ color:var(--aqua-900); font-weight:700; }

  /* ===== ERRORS ===== */
  .error-message{ color:#ef4444; font-size:.9rem; margin-top:.35rem; display:none; }

  /* ===== SECTION REVEAL ===== */
  .reveal{ opacity:0; transform: translateY(26px); }
  .reveal.visible{ opacity:1; transform:none; transition: opacity .8s ease, transform .8s ease; }

  /* ===== RESPONSIVE ===== */
  @media (max-width:768px){
    .btn-found-pet,.btn-cancel{ width:100%; margin-bottom:.55rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="found-pet-bg">
  <div class="paws"></div>

  <div class="container">
    <!-- Header -->
    <div class="header-wrap animate__animated animate__fadeInDown">
      <span class="hero-chip"><i class="fas fa-heart"></i> Community Rescue</span>
      <h1 class="page-title">Report a Found Pet</h1>
      <p class="page-sub">Your kindness helps reunite families. Share what you know and we‚Äôll amplify it across our network.</p>
    </div>

    <!-- Warm message -->
    <div class="row justify-content-center mb-3 reveal">
      <div class="col-lg-8">
        <div class="alert alert-found text-center" role="alert">
          <h4 class="alert-heading">Thank you for being a hero! üêæ</h4>
          <p class="mb-0">Every report boosts the chances of bringing a furry friend back home.</p>
        </div>
      </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="row justify-content-center reveal">
          <div class="col-lg-8">
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show text-center" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          </div>
        </div>
      {% endfor %}
    {% endif %}

    <!-- Main Card -->
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="report-card reveal">
          <div class="card-header-found">
            <h2><i class="fas fa-paw me-2"></i>Found Pet Details</h2>
            <p>Please provide as much detail as possible to help locate the owner.</p>
          </div>

          <div class="form-container">
            <form method="POST" enctype="multipart/form-data" id="found-pet-form">
              {% csrf_token %}

              <div class="row">
                <div class="col-md-6 mb-4">
                  <label for="{{ form.pet_type.id_for_label }}" class="form-label">Pet Type <span class="text-danger">*</span></label>
                  {{ form.pet_type }}
                  <div id="pet_type-error" class="error-message" data-field="pet_type"></div>
                </div>

                <div class="col-md-6 mb-4">
                  <label for="{{ form.breed.id_for_label }}" class="form-label">Breed <span class="text-danger">*</span></label>
                  {{ form.breed }}
                  <div id="breed-error" class="error-message" data-field="breed"></div>
                  <div class="form-text">If unknown, you can write ‚ÄúMixed‚Äù or leave blank if optional.</div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-4">
                  <label for="{{ form.color.id_for_label }}" class="form-label">Primary Color <span class="text-danger">*</span></label>
                  {{ form.color }}
                  <div id="color-error" class="error-message" data-field="color"></div>
                </div>

                <div class="col-md-6 mb-4">
                  <label for="{{ form.location.id_for_label }}" class="form-label">Location Found <span class="text-danger">*</span></label>
                  {{ form.location }}
                  <div id="location-error" class="error-message" data-field="location"></div>
                  <div class="form-text">Nearest landmark or area name helps a lot.</div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-4">
                  <label for="{{ form.date_found.id_for_label }}" class="form-label">Date Found <span class="text-danger">*</span></label>
                  {{ form.date_found }}
                  <div id="date_found-error" class="error-message" data-field="date_found"></div>
                </div>
                <div class="col-md-6 mb-4">
                  <!-- spacer -->
                </div>
              </div>

              <div class="mb-4">
                <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                {{ form.description }}
                <div id="description-error" class="error-message" data-field="description"></div>
                <div class="form-text">Behavior, collar/tag info, unique marks, friendliness, etc.</div>
              </div>

              <div class="mb-4">
                <label for="{{ form.image.id_for_label }}" class="form-label">Photos of Pet</label>
                <div class="image-upload-area" id="image-upload-trigger">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <p class="mb-1"><strong>Click to upload</strong> clear photos</p>
                  <p class="text-muted small mb-0">JPG/PNG ‚Ä¢ up to 5MB each ‚Ä¢ multiple allowed</p>
                </div>
                {{ form.image }}
                <div id="image-error" class="error-message" data-field="image"></div>

                <div class="image-preview-container mt-3" id="image-preview">
                  <div class="row g-2" id="preview-container"></div>
                </div>
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-2">
                <button type="submit" class="btn-found-pet flex-fill" id="submit-btn">
                  <span class="me-1">Report Found Pet</span> <i class="fas fa-paper-plane"></i>
                </button>
                <a href="{% url 'home' %}" class="btn-cancel flex-fill ms-md-2">
                  <i class="fas fa-arrow-left"></i> Back to Home
                </a>
              </div>
            </form>
          </div>
        </div>

        <!-- Help Panel -->
        <div class="reveal mt-3">
          <div class="alert-found">
            <h5 class="mb-2"><i class="fas fa-lightbulb me-2"></i> Helpful tips</h5>
            <ul class="mb-0">
              <li>Clear photos (face + body) improve matches.</li>
              <li>Share location precisely (area, landmark, pin if possible).</li>
              <li>Update if the pet moves to a shelter or owner contacts you.</li>
            </ul>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // ===== Section Reveal on Scroll =====
  document.addEventListener('DOMContentLoaded', () => {
    const toReveal = document.querySelectorAll('.reveal');
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          e.target.classList.add('visible');
          io.unobserve(e.target);
        }
      });
    }, {threshold:.12});
    toReveal.forEach(el=>io.observe(el));
  });

  // ===== Image Preview + Multiple =====
  document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('{{ form.image.id_for_label }}');
    const imagePreview = document.getElementById('image-preview');
    const previewContainer = document.getElementById('preview-container');
    const imageUploadArea = document.getElementById('image-upload-trigger');

    if (imageInput) {
      imageInput.style.display = 'none';
      imageInput.setAttribute('multiple', true);

      imageUploadArea.addEventListener('click', function() {
        imageInput.click();
      });

      imageInput.addEventListener('change', function(e) {
        handleImageSelection(e);
      });
    }

    function handleImageSelection(e) {
      const files = e.target.files;
      if (files && files.length > 0) {
        imagePreview.style.display = 'block';
        imageUploadArea.style.display = 'none';

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (!file) continue;
          const reader = new FileReader();
          reader.onload = function(ev) {
            addImagePreview(ev.target.result, previewContainer.children.length);
          }
          reader.readAsDataURL(file);
        }
      } else {
        imagePreview.style.display = 'none';
        imageUploadArea.style.display = 'block';
      }
    }

    function addImagePreview(src, index) {
      const col = document.createElement('div');
      col.className = 'col-6 col-md-3 preview-col';
      col.id = 'preview-col-' + index;

      const img = document.createElement('img');
      img.src = src;
      img.alt = 'Pet Photo Preview ' + (index + 1);
      img.className = 'preview-image img-fluid';

      const removeBtn = document.createElement('div');
      removeBtn.className = 'remove-btn';
      removeBtn.innerHTML = '<i class="fas fa-times"></i>';
      removeBtn.addEventListener('click', function(e){
        e.stopPropagation();
        col.remove();
        if (previewContainer.children.length === 0) {
          imagePreview.style.display = 'none';
          imageUploadArea.style.display = 'block';
        }
      });

      const addMoreBtn = document.createElement('div');
      addMoreBtn.className = 'add-more-btn';
      addMoreBtn.innerHTML = '<i class="fas fa-plus"></i>';
      addMoreBtn.addEventListener('click', function(e){
        e.stopPropagation();
        imageInput.click();
      });

      col.appendChild(img);
      col.appendChild(removeBtn);
      col.appendChild(addMoreBtn);
      previewContainer.appendChild(col);
    }

    // ===== Inline Validation =====
    const form = document.getElementById('found-pet-form');
    const submitBtn = document.getElementById('submit-btn');

    if (form) {
      const inputs = form.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.addEventListener('input', () => hideFieldError(input.name));
        input.addEventListener('blur', () => validateField(input));
      });

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        hideAllErrors();
        let isValid = true;
        inputs.forEach(input => { if (!validateField(input)) isValid = false; });

        if (isValid) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Submitting...';
          form.submit();
        } else {
          const firstError = form.querySelector('.error-message[style*="block"]');
          if (firstError) firstError.scrollIntoView({ behavior:'smooth', block:'center' });
        }
      });
    }

    function validateField(field){
      let ok = true;

      if (field.name === 'pet_type' && !field.value){
        showFieldError(field.name, 'Please select a pet type.');
        ok = false;
      }

      if (field.name === 'location'){
        if (!field.value) { showFieldError(field.name, 'Location is required.'); ok = false; }
        else if (field.value.length < 5) { showFieldError(field.name, 'Please provide a more specific location (min 5 characters).'); ok = false; }
      }

      if (field.name === 'date_found'){
        if (!field.value){ showFieldError(field.name,'Date found is required.'); ok = false; }
        else{
          const d = new Date(field.value); const today = new Date();
          d.setHours(0,0,0,0); today.setHours(0,0,0,0);
          if (d > today){ showFieldError(field.name,'Date cannot be in the future.'); ok = false; }
        }
      }

      if (field.name === 'image' && field.files && field.files.length){
        const allowed = ['.jpg','.jpeg','.png']; const max = 5 * 1024 * 1024;
        for (let f of field.files){
          const ext = '.' + f.name.split('.').pop().toLowerCase();
          if (!allowed.includes(ext)){ showFieldError(field.name,'Only JPG/PNG files are allowed.'); ok = false; break; }
          if (f.size > max){ showFieldError(field.name,'Each image must be under 5MB.'); ok = false; break; }
        }
      }
      if (field.required && !field.value &&
          field.name!=='pet_type' && field.name!=='date_found' && field.name!=='location'){
        showFieldError(field.name,'This field is required.'); ok = false;
      }
      return ok;
    }

    function showFieldError(name, msg){
      const el = document.getElementById(name + '-error');
      if (!el) return;
      el.textContent = msg; el.style.display = 'block';
    }
    function hideFieldError(name){
      const el = document.getElementById(name + '-error');
      if (el) el.style.display = 'none';
    }
    function hideAllErrors(){
      document.querySelectorAll('.error-message').forEach(e=>e.style.display='none');
    }
  });
</script>
{% endblock %}
